name: Build Sofle Keyboard Firmware

on: 
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    container:
      image: zmkfirmware/zmk-build-arm:stable
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Install Python Dependencies
      run: |
        apt-get update
        apt-get install -y python3-distutils
        echo "âœ… Python dependencies installed"
    
    - name: Create Minimal Configuration
      run: |
        echo "ðŸ§ª Creating configuration file..."
        rm -f config/sofle.conf
        cat > config/sofle.conf << 'EOF'
        # Minimal configuration for Sofle Keyboard
        CONFIG_ZMK_USB=y
        CONFIG_ZMK_BLE=y
        CONFIG_ZMK_SPLIT=y
        EOF
        
        echo "ðŸ“„ Configuration content:"
        cat config/sofle.conf
        echo "âœ… Configuration created successfully"
    
    - name: Initialize West
      run: |
        echo "ðŸš€ Initializing West..."
        west init -l config
        echo "âœ… West initialized"
    
    - name: Update West Modules
      run: |
        echo "ðŸ“¥ Updating West modules..."
        west update
        echo "âœ… West modules updated"
    
    - name: Export Zephyr Environment
      run: |
        echo "ðŸ”§ Exporting Zephyr environment..."
        west zephyr-export
        echo "âœ… Zephyr environment exported"
    
    - name: Build Left Side (Central)
      run: |
        echo "ðŸ”¨ Building left side (central)..."
        west build -s zmk/app -b nice_nano_v2 -- \
          -DSHIELD=sofle_left \
          -DZMK_CONFIG="$GITHUB_WORKSPACE/config"
        echo "âœ… Left side built successfully"
        
        cp build/zephyr/zmk.uf2 sofle_left.uf2
        echo "ðŸ“ Left firmware: sofle_left.uf2"
        ls -la *.uf2
    
    - name: Build Right Side (Peripheral)
      run: |
        echo "ðŸ”¨ Building right side (peripheral)..."
        rm -rf build
        west build -s zmk/app -b nice_nano_v2 -- \
          -DSHIELD=sofle_right \
          -DZMK_CONFIG="$GITHUB_WORKSPACE/config" \
          -DCONFIG_ZMK_SPLIT_BLE_ROLE_CENTRAL=n
        echo "âœ… Right side built successfully"
        
        cp build/zephyr/zmk.uf2 sofle_right.uf2
        echo "ðŸ“ Right firmware: sofle_right.uf2"
        ls -la *.uf2
    
    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sofle-keyboard-firmware
        path: |
          sofle_left.uf2
          sofle_right.uf2
        retention-days: 30
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Show Download Instructions
      run: |
        echo "ðŸŽ‰ Build completed successfully!"
        echo ""
        echo "ðŸ“¥ DOWNLOAD INSTRUCTIONS:"
        echo "1. Go to the 'Actions' tab in your repository"
        echo "2. Click on the latest workflow run"
        echo "3. Scroll down to the 'Artifacts' section"
        echo "4. Click on 'sofle-keyboard-firmware' to download"
        echo "5. Extract the ZIP file to get the .uf2 files"
        echo ""
        echo "ðŸ”§ FLASHING INSTRUCTIONS:"
        echo "1. Connect RIGHT half via USB"
        echo "2. Double-tap reset button to enter bootloader"
        echo "3. Drag 'sofle_right.uf2' to the USB drive"
        echo "4. Repeat for LEFT half with 'sofle_left.uf2'"
        echo ""
        echo "ðŸ“± ZMK APP: After flashing, use ZMK app to configure"