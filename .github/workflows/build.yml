name: Build

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-20.04  # Используем Ubuntu 20.04 (Python 3.8)
    name: Build Sofle Keyboard
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          submodules: recursive
          
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler \
            wget python3 python3-pip python3-setuptools \
            python3-dev python3-tk python3-wheel \
            xz-utils file make gcc g++ \
            libsdl2-dev libusb-1.0-0-dev
            
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install West
        run: |
          pip3 install --upgrade pip
          pip3 install west
          
      - name: Initialize ZMK
        run: |
          west init -l config
          west update
          west zephyr-export
          
      - name: Build Left Side
        run: |
          west build -s zmk/app -b nice_nano_v2 \
            -- -DSHIELD=sofle_left \
               -DZMK_CONFIG="${GITHUB_WORKSPACE}/config"
          cp build/zephyr/zmk.uf2 sofle_left_nice_nano_v2.uf2
          
      - name: Build Right Side
        run: |
          west build --pristine -s zmk/app -b nice_nano_v2 \
            -- -DSHIELD=sofle_right \
               -DZMK_CONFIG="${GITHUB_WORKSPACE}/config"
          cp build/zephyr/zmk.uf2 sofle_right_nice_nano_v2.uf2
          
      - name: List Build Artifacts
        run: ls -la *.uf2
        
      - name: Upload Firmware
        uses: actions/upload-artifact@v3
        with:
          name: sofle-firmware
          path: |
            sofle_left_nice_nano_v2.uf2
            sofle_right_nice_nano_v2.uf2
          retention-days: 7